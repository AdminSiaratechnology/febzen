{% extends "fabzen_app/Base/base.html" %}
{% load static %}

{% block title %}Create Purchase Order{% endblock title %}

{% block main-content %}
<div class="page-content">

  <!-- Page Header -->
   <a href="{% url 'purchaseorder' %}" class="btn btn-outline-primary btn-sm shadow-sm">
      <i class="fadeIn animated bx bx-arrow-to-left"></i>
    </a>

  <!-- Main Form -->
  <form method="POST"  >
    {% csrf_token %}

    <!-- Basic Details Card -->
    <div class="card border-0 shadow-sm rounded-4 border-bottom" style="margin-bottom: 0;">
      <div class="card-header bg-gradient text-white py-3 rounded-top-4" 
           style="background: linear-gradient(90deg, #0d6efd, #007bff);">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-info-circle me-2"></i>Purchase Order Details</h6>
        
      </div>
      <div class="card-body bg-white p-4 " >
        <div class="row g-4">
          <div class="col-md-3">
            <label class="form-label fw-semibold">PO Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control form-control-sm shadow-sm" name="po_date" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">PO Number <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-sm shadow-sm" name="po_no" placeholder="PO-XXX" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Delivery Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control form-control-sm shadow-sm" name="delivery_date" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Payment Terms <span class="text-danger">*</span></label>
            <select name="payment_terms" class="form-select form-select-sm shadow-sm" required>
              <option value="" disabled selected>Select Term</option>
              <option value="Immediate">Immediate</option>
              <option value="30 Days">30 Days</option>
              <option value="60 Days">60 Days</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Supplier <span class="text-danger">*</span></label>
            <select name="supplier" class="form-select form-select-sm shadow-sm" required>
              <option value="" disabled selected>Select Supplier</option>
              <option>Surat Mills Ltd</option>
              <option>Gujarat Textiles</option>
              <option>Ahmedabad Fab</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Terms & Condition</label>
            <textarea class="form-control form-control-sm shadow-sm" name="terms" rows="2" placeholder="Payment terms, delivery conditions, etc."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Items Table Card -->
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-header d-flex justify-content-between align-items-center py-3 bg-light border-bottom">
        
        <button type="button" id="addItemBtn" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-plus-circle me-1"></i> Add Item
        </button>
      </div>
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered align-middle mb-0 text-center">
          <thead class="table-light sticky-top">
            <tr>
              <th>#</th>
              <th style="min-width: 250px;">Item / Description</th>
              <th>Color</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Rate</th>
              <th>Discount</th>
              <th>Amount</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="itemsTableBody">
            <tr>
              <td>1</td>
              <td class="text-start">
                <select name="item_description[]" class="form-select form-select-sm shadow-sm mb-1" required onchange="fetchGarmentDetails(this)">
                  <option value="" selected disabled>Select Quality</option>
                  {% for i in garment %}
                    <option value="{{ i.id }}">{{ i.garment_name }}</option>
                  {% endfor %}
                </select>
                <textarea class="form-control form-control-sm shadow-sm" name="description[]" rows="1" placeholder="Auto description..."></textarea>
              </td>
              <td>
                <select class="form-select form-select-sm shadow-sm" name="color[]" required>
                  <option value="" selected disabled>Color</option>
                  <option>Navy Blue</option>
                  <option>White</option>
                  <option>Black</option>
                  <option>Red</option>
                </select>
              </td>
              <td><input type="number" class="form-control form-control-sm text-center shadow-sm" name="quantity[]" placeholder="Qty" min="1"></td>
              <td>
                <select class="form-select form-select-sm shadow-sm text-center" name="unit[]" required>
                  <option value="" selected disabled>Unit</option>
                  <option>Pcs</option>
                  <option>Kg</option>
                  <option>Meter</option>
                  <option>Liter</option>
                </select>
              </td>
              <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="price[]" placeholder="0" step="0.01"></td>
              <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="discount[]" placeholder="0" step="0.01"></td>
              <td><input type="number" class="form-control form-control-sm text-center shadow-sm" name="amount[]" placeholder="0" readonly></td>
              <td><button type="button" class="btn btn-sm btn-outline-danger remove-row" disabled><i class="bx bx-trash"></i></button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bill Summary -->
    <div class="d-flex justify-content-end mt-4">
      <div class="card shadow-sm border-0 rounded-4" style="width: 400px;">
        <div class="card-header text-white py-3 rounded-top-4" 
             style="background: linear-gradient(90deg, #0d6efd, #007bff);">
          <h6 class="mb-0 fw-semibold text-light"><i class="bx bx-receipt me-2 text-light"></i>Bill Summary</h6>
        </div>
        <div class="card-body bg-white p-4">
          <div class="d-flex justify-content-between mb-2">
            <label>Subtotal</label>
            <input type="text" id="subtotal" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0.00" readonly>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <select class="form-select w-50" id="ledger_name">
              <option disabled selected>Ledger</option>
              <option>Reactive</option>
              <option>Solution</option>
              <option>Conglomeration</option>
              <option>Algoritm</option>
              <option>Holistic</option>
            </select>
            <input type="number" id="ledger_amount" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0" value="0">
          </div>
          <div class="d-flex justify-content-between mb-2">
            <label>CGST (%)</label>
            <input type="number" id="cgst" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0" value="0">
          </div>
          <div class="d-flex justify-content-between mb-2">
            <label>SGST (%)</label>
            <input type="number" id="sgst" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0" value="0">
          </div>
          <div class="d-flex justify-content-between mb-2">
            <label>IGST (%)</label>
            <input type="number" id="igst" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0" value="0">
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <label class="fw-bold text-primary">Total</label>
            <input type="text" id="total" class="form-control form-control-sm fw-bold text-end w-50 bg-light border-0" placeholder="0.00" readonly>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="text-end mt-4">
      <button type="submit" class="btn btn-primary px-5 fw-semibold shadow-sm">
        <i class="bi bi-save me-1"></i> Save Order
      </button>
    </div>

  </form>
</div>
{% comment %} 
<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsTableBody = document.getElementById('itemsTableBody');
    const subtotalInput = document.getElementById('subtotal');
    const ledgerInput = document.getElementById('ledger_amount');
    const cgstInput = document.getElementById('cgst');
    const sgstInput = document.getElementById('sgst');
    const igstInput = document.getElementById('igst');
    const totalInput = document.getElementById('total');

    // ‚úÖ Function to calculate subtotal
    function updateSubtotal() {
        let subtotal = 0;
        const amountInputs = itemsTableBody.querySelectorAll('input[name="amount[]"]');
        amountInputs.forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });
        subtotalInput.value = subtotal.toFixed(2);
        updateTotal();
    }

    // ‚úÖ Function to calculate final total
    function updateTotal() {
        const subtotal = parseFloat(subtotalInput.value) || 0;
        const ledger = parseFloat(ledgerInput.value) || 0;
        const cgst = parseFloat(cgstInput.value) || 0;
        const sgst = parseFloat(sgstInput.value) || 0;
        const igst = parseFloat(igstInput.value) || 0;

        // Calculate tax amounts on subtotal
        const cgstAmt = subtotal * (cgst / 100);
        const sgstAmt = subtotal * (sgst / 100);
        const igstAmt = subtotal * (igst / 100);

        const total = subtotal + ledger + cgstAmt + sgstAmt + igstAmt;
        totalInput.value = total.toFixed(2);
    }

    // Add change listeners for ledger & taxes
    [ledgerInput, cgstInput, sgstInput, igstInput].forEach(el => {
        el.addEventListener('input', updateTotal);
    });

    // ‚úÖ Listen for quantity/price updates
    itemsTableBody.addEventListener('input', function(e) {
        if (e.target.name === 'quantity[]' || e.target.name === 'price[]') {
            const row = e.target.closest('tr');
            const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
            const price = parseFloat(row.querySelector('input[name="price[]"]').value) || 0;
            const amount = row.querySelector('input[name="amount[]"]');
            amount.value = (qty * price).toFixed(2);
            updateSubtotal();
        }
    });

    // ‚úÖ Fetch garment details (and recalc subtotal)
    window.fetchGarmentDetails = function(selectElement) {
        const garmentId = selectElement.value;
        if (!garmentId) return;

        fetch(`/get-garment-details/${garmentId}/`)
            .then(res => res.json())
            .then(data => {
                const row = selectElement.closest('tr');
                row.querySelector('textarea[name="description[]"]').value = data.description || '';
                const priceInput = row.querySelector('input[name="price[]"]');
                priceInput.value = data.price || 0;

                const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
                row.querySelector('input[name="amount[]"]').value = (qty * (data.price || 0)).toFixed(2);
                updateSubtotal();
            })
            .catch(err => console.error('Error fetching details:', err));
    };
});
</script> {% endcomment %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addItemBtn = document.getElementById('addItemBtn');
    const itemsTableBody = document.getElementById('itemsTableBody');

    const subtotalInput = document.getElementById('subtotal');
    const ledgerInput = document.getElementById('ledger_amount');
    const cgstInput = document.getElementById('cgst');
    const sgstInput = document.getElementById('sgst');
    const igstInput = document.getElementById('igst');
    const totalInput = document.getElementById('total');

    // ‚úÖ Function: Calculate subtotal
    function updateSubtotal() {
        let subtotal = 0;
        const amountInputs = itemsTableBody.querySelectorAll('input[name="amount[]"]');
        amountInputs.forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });
        subtotalInput.value = subtotal.toFixed(2);
        updateTotal();
    }

    // ‚úÖ Function: Calculate total with taxes
    function updateTotal() {
        const subtotal = parseFloat(subtotalInput.value) || 0;
        const ledger = parseFloat(ledgerInput.value) || 0;
        const cgst = parseFloat(cgstInput.value) || 0;
        const sgst = parseFloat(sgstInput.value) || 0;
        const igst = parseFloat(igstInput.value) || 0;

        const cgstAmt = subtotal * (cgst / 100);
        const sgstAmt = subtotal * (sgst / 100);
        const igstAmt = subtotal * (igst / 100);

        const total = subtotal + ledger + cgstAmt + sgstAmt + igstAmt;
        totalInput.value = total.toFixed(2);
    }

    // ‚úÖ Function: Attach qty/price listeners to a row
    function attachCalculationListeners(row) {
        const qtyInput = row.querySelector('input[name="quantity[]"]');
        const priceInput = row.querySelector('input[name="price[]"]');
        const amountInput = row.querySelector('input[name="amount[]"]');
        const discountInput = row.querySelector('input[name="discount[]"]');

        function updateAmount() {
            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            

            const discountedPrice = price - (price * (discount / 100));
            amountInput.value = (qty * discountedPrice).toFixed(2);
            updateSubtotal();
        }

        qtyInput.addEventListener('input', updateAmount);
        priceInput.addEventListener('input', updateAmount);
        discountInput.addEventListener('input', updateAmount);
    }

    // ‚úÖ Function: Remove a row
    function removeRow(row) {
        row.remove();
        const rows = itemsTableBody.querySelectorAll('tr');
        rows.forEach((r, i) => r.cells[0].textContent = i + 1);

        if (rows.length === 1) {
            rows[0].querySelector('.remove-row').disabled = true;
        }

        updateSubtotal();
    }

    // ‚úÖ Function: Add new row
    addItemBtn.addEventListener('click', function() {
        const rowCount = itemsTableBody.querySelectorAll('tr').length;

        const newRow = document.createElement('tr');
        newRow.className = 'item-row text-center';
        newRow.innerHTML = `
            <td>${rowCount + 1}</td>
            <td>
                <select class="form-select form-select-sm shadow-sm" name="item_description[]" onchange="fetchGarmentDetails(this)">
                    <option value="" selected disabled>Select</option>
                    {% for i in garment %}
                        <option value="{{ i.id }}">{{ i.garment_name }}</option>
                    {% endfor %}
                </select>
                <textarea class="form-control form-control-sm shadow-sm" name="description[]" rows="1" placeholder="Enter item details..."></textarea>
            </td>
            <td>
                <select class="form-select form-select-sm shadow-sm" name="color[]">
                    <option value="" selected disabled>Color</option>
                    <option value="Navy Blue">Navy Blue</option>
                    <option value="White">White</option>
                    <option value="Black">Black</option>
                    <option value="Red">Red</option>
                </select>
            </td>
            <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="quantity[]" placeholder="Qty" min="1"></td>
            <td>
                <select class="form-select form-select-sm shadow-sm text-center" name="unit[]">
                    <option value="" selected disabled>Unit</option>
                    <option>Pcs</option>
                    <option>Kg</option>
                    <option>Meter</option>
                    <option>Liter</option>
                </select>
            </td>
            <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="price[]" placeholder="0" min="0" step="0.01"></td>
            <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="discount[]" placeholder="0" step="0.01"></td>
            <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="amount[]" placeholder="0" readonly></td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger remove-row">
                    <i class="bx bx-trash"></i>
                </button>
            </td>
        `;

        itemsTableBody.appendChild(newRow);

        // Enable/disable remove buttons
        const removeButtons = itemsTableBody.querySelectorAll('.remove-row');
        removeButtons.forEach(btn => btn.disabled = removeButtons.length <= 1);

        attachCalculationListeners(newRow);

        const removeBtn = newRow.querySelector('.remove-row');
        removeBtn.addEventListener('click', function() {
            removeRow(newRow);
        });
    });

    // ‚úÖ Garment details fetch (with recalculation)
    window.fetchGarmentDetails = function(selectElement) {
        const garmentId = selectElement.value;
        if (!garmentId) return;

        fetch(`/get-garment-details/${garmentId}/`)
            .then(res => res.json())
            .then(data => {
                const row = selectElement.closest('tr');
                row.querySelector('textarea[name="description[]"]').value = data.description || '';
                const priceInput = row.querySelector('input[name="price[]"]');
                priceInput.value = data.price || 0;

                const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
                row.querySelector('input[name="amount[]"]').value = (qty * (data.price || 0)).toFixed(2);
                updateSubtotal();
            })
            .catch(err => console.error('Error fetching details:', err));
    };

    // ‚úÖ Initial setup for existing rows
    const existingRows = itemsTableBody.querySelectorAll('tr');
    existingRows.forEach(row => {
        attachCalculationListeners(row);
        const removeBtn = row.querySelector('.remove-row');
        removeBtn.addEventListener('click', function() {
            removeRow(row);
        });
    });

    // ‚úÖ Update total when taxes or ledger change
    [ledgerInput, cgstInput, sgstInput, igstInput].forEach(el => {
        el.addEventListener('input', updateTotal);
    });
});
</script>

{% comment %} <style>
  body { background-color: #f5f7fa !important; }
  .table th, .table td { vertical-align: middle !important; }
  .table-hover tbody tr:hover { background: #f1f6ff !important; transition: 0.3s; }
  .form-control-sm, .form-select-sm { border-radius: 8px; }
</style> {% endcomment %}


<style>
/* üåê Background */
body {
  background-color: #f5f7fa !important;
}

/* üü£ Compact Table Look */
.table th, 
.table td {
  vertical-align: middle !important;
  font-size: 0.82rem !important; /* smaller text */
  padding: 0.4rem 0.5rem !important; /* tighter cell spacing */
}

/* ü©µ Hover effect */
.table-hover tbody tr:hover {
  background-color: #eef5ff !important;
  transition: background 0.3s ease;
}

/* ‚ú® Compact form controls */
.form-control-sm,
.form-select-sm {
  border-radius: 0.4rem;
  font-size: 0.82rem !important;
  padding: 0.25rem 0.4rem !important;
  height: calc(1.5em + 0.5rem + 2px) !important;
}

/* üßæ Column Width Adjustments */
.table th:nth-child(1) { width: 35px; }   /* # */
.table th:nth-child(2) { width: 260px; }  /* Item / Description */
.table th:nth-child(3) { width: 100px; }  /* Color */
.table th:nth-child(4) { width: 70px; }   /* Qty */
.table th:nth-child(5) { width: 90px; }   /* Unit */
.table th:nth-child(6) { width: 90px; }   /* Rate */
.table th:nth-child(7) { width: 75px; }   /* Discount */
.table th:nth-child(8) { width: 100px; }  /* Amount */
.table th:nth-child(9) { width: 70px; }   /* Action */

/* üßπ Buttons */
.btn-sm {
  padding: 0.25rem 0.5rem !important;
  font-size: 0.82rem !important;
  border-radius: 0.3rem;
}

/* Trash icon smaller */
.remove-row i {
  font-size: 0.9rem;
}

.card-body.p-4 {
  padding: 1rem 1.25rem !important; /* reduce padding inside card */
}

.card-header.py-3 {
  padding: 0.6rem 1rem !important; /* smaller header height */
}

/* Smaller labels and inputs inside top section */
.card-body .form-label {
  font-size: 0.82rem !important;
  margin-bottom: 0.25rem !important;
}

.card-body .form-control-sm,
.card-body .form-select-sm {
  height: calc(1.4em + 0.4rem + 2px) !important;
  font-size: 0.8rem !important;
  padding: 0.25rem 0.4rem !important;
}

/* Reduce row spacing between inputs */
.card-body .row.g-4 {
  --bs-gutter-x: 0.75rem !important;
  --bs-gutter-y: 0.75rem !important;
}

/* Make heading smaller and more compact */
.card-header h6 {
  font-size: 0.95rem !important;
  margin: 0;
}

/* Adjust bottom space between cards */
.card.border-0.shadow-sm.rounded-4.mb-4 {
  margin-bottom: 1rem !important;
}

/* Sticky header with light shadow */
thead.table-light.sticky-top {
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.table-responsive.fixed-height {
  max-height: 350px; /* üîπ Change height here (e.g., 300px / 350px / 400px) */
  overflow-y: auto;
  overflow-x: hidden;
  border-radius: 0 0 0.5rem 0.5rem;
  border-top: 1px solid #dee2e6;
  scrollbar-width: thin;
  scrollbar-color: #c7d4e2 #f8f9fa;
}

/* ‚úÖ For Webkit browsers (Chrome, Edge, Safari) */
.table-responsive.fixed-height::-webkit-scrollbar {
  width: 6px;
}
.table-responsive.fixed-height::-webkit-scrollbar-track {
  background: #f8f9fa;
}
.table-responsive.fixed-height::-webkit-scrollbar-thumb {
  background-color: #b9c7db;
  border-radius: 4px;
}

/* ü©µ Sticky header stays visible */
.table thead th {
  position: sticky;
  top: 0;
  z-index: 2;
  background-color: #f8f9fa !important;
  box-shadow: 0 2px 3px rgba(0,0,0,0.05);
}
</style>


{% endblock main-content %}

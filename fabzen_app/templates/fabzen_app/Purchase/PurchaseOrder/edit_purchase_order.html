{% extends "fabzen_app/Base/base.html" %}
{% load static %}

{% block title %}Edit Purchase Order{% endblock title %}

{% block main-content %}
<div class="page-content bg-light p-4">

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
    <div>
      <h3 class="fw-semibold text-primary mb-0">
        <i class="bi bi-pencil-square me-2"></i> Edit Purchase Order - {{ purchase_order.po_no }}
      </h3>
      <p class="text-muted small mb-0">Update purchase order details and items</p>
    </div>
    <a href="{% url 'purchaseorder' %}" class="btn btn-outline-primary btn-sm shadow-sm">
      <i class="bi bi-arrow-left-circle me-1"></i> Back to List
    </a>
  </div>

  <!-- Main Form -->
  <form method="POST">
    {% csrf_token %}

    <!-- Basic Details Card -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
      <div class="card-header bg-gradient text-white py-3 rounded-top-4" 
           style="background: linear-gradient(90deg, #0d6efd, #007bff);">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-info-circle me-2"></i>Purchase Order Details</h6>
      </div>
      <div class="card-body bg-white p-4">
        <div class="row g-4">
          <div class="col-md-3">
            <label class="form-label fw-semibold">PO Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control form-control-sm shadow-sm" 
                   name="po_date" value="{{ purchase_order.po_date|date:'Y-m-d' }}" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">PO Number <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-sm shadow-sm" 
                   name="po_no" value="{{ purchase_order.po_no }}" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Delivery Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control form-control-sm shadow-sm" 
                   name="delivery_date" value="{{ purchase_order.delivery_date|date:'Y-m-d' }}" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Payment Terms <span class="text-danger">*</span></label>
            <select name="payment_terms" class="form-select form-select-sm shadow-sm" required>
              <option value="" disabled>Select Term</option>
              {% for key, val in purchase_order.PAYMENT_TERMS %}
                <option value="{{ key }}" {% if purchase_order.payment_terms == key %}selected{% endif %}>{{ val }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Supplier <span class="text-danger">*</span></label>
            <select name="supplier" class="form-select form-select-sm shadow-sm" required>
              <option value="" disabled>Select Supplier</option>
              <option value="Surat Mills Ltd" {% if purchase_order.supplier == 'Surat Mills Ltd' %}selected{% endif %}>Surat Mills Ltd</option>
              <option value="Gujarat Textiles" {% if purchase_order.supplier == 'Gujarat Textiles' %}selected{% endif %}>Gujarat Textiles</option>
              <option value="Ahmedabad Fab" {% if purchase_order.supplier == 'Ahmedabad Fab' %}selected{% endif %}>Ahmedabad Fab</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Terms & Condition</label>
            <textarea class="form-control form-control-sm shadow-sm" 
                      name="terms" rows="2">{{ purchase_order.termscondition }}</textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Items Table Card -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
      <div class="card-header d-flex justify-content-between align-items-center py-3 bg-light border-bottom">
        <h6 class="fw-semibold mb-0"><i class="bi bi-bag-check me-2"></i>Purchase Order Items</h6>
        <button type="button" id="addItemBtn" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-plus-circle me-1"></i> Add Item
        </button>
      </div>
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered align-middle mb-0 text-center">
          <thead class="table-light sticky-top">
            <tr>
              <th>#</th>
              <th>Item / Description</th>
              <th>Color</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Rate</th>
              <th>Discount</th>
              <th>Amount</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="itemsTableBody">
            {% for item in purchase_order.items.all %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td class="text-start">
                  <select name="item_description[]" class="form-select form-select-sm shadow-sm mb-1" required onchange="fetchGarmentDetails(this)">
                    <option value="" disabled>Select Quality</option>
                    {% for i in garment %}
                      <option value="{{ i.id }}" {% if item.garment.id == i.id %}selected{% endif %}>{{ i.garment_name }}</option>
                    {% endfor %}
                  </select>
                  <textarea class="form-control form-control-sm shadow-sm" name="description[]" rows="1">{{ item.description }}</textarea>
                </td>
                <td>
                  <select class="form-select form-select-sm shadow-sm" name="color[]" required>
                    <option value="" disabled>Color</option>
                    <option {% if item.color == 'Navy Blue' %}selected{% endif %}>Navy Blue</option>
                    <option {% if item.color == 'White' %}selected{% endif %}>White</option>
                    <option {% if item.color == 'Black' %}selected{% endif %}>Black</option>
                    <option {% if item.color == 'Red' %}selected{% endif %}>Red</option>
                  </select>
                </td>
                <td><input type="number" class="form-control form-control-sm text-center shadow-sm" name="quantity[]" value="{{ item.quantity }}"></td>
                <td>
                  <select class="form-select form-select-sm shadow-sm text-center" name="unit[]" required>
                    <option value="" disabled>Unit</option>
                    <option {% if item.uom == 'Pcs' %}selected{% endif %}>Pcs</option>
                    <option {% if item.uom == 'Kg' %}selected{% endif %}>Kg</option>
                    <option {% if item.uom == 'Meter' %}selected{% endif %}>Meter</option>
                    <option {% if item.uom == 'Liter' %}selected{% endif %}>Liter</option>
                  </select>
                </td>
                <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="price[]" value="{{ item.rate }}" step="0.01"></td>
                <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="discount[]" value="{{ item.discount }}" step="0.01"></td>
                <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="amount[]" value="{{ item.amount }}" readonly></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger remove-row"><i class="bx bx-trash"></i></button></td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="9" class="text-muted">No items found.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bill Summary -->
    <div class="d-flex justify-content-end mt-4">
      <div class="card shadow-sm border-0 rounded-4" style="width: 400px;">
        <div class="card-header text-white py-3 rounded-top-4" 
             style="background: linear-gradient(90deg, #0d6efd, #007bff);">
          <h6 class="mb-0 fw-semibold text-light"><i class="bx bx-receipt me-2 text-light"></i>Bill Summary</h6>
        </div>
        <div class="card-body bg-white p-4">
          <div class="d-flex justify-content-between mb-2">
            <label>Subtotal</label>
            <input type="text" id="subtotal" class="form-control form-control-sm text-end w-50 shadow-sm" 
                   value="{{ purchase_order.total_amount }}" readonly>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <select class="form-select w-50" id="ledger_name">
              <option disabled selected>Ledger</option>
              <option>Reactive</option>
              <option>Solution</option>
              <option>Conglomeration</option>
              <option>Algoritm</option>
              <option>Holistic</option>
            </select>
            <input type="number" id="ledger_amount" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0" value="0">
          </div>
          <div class="d-flex justify-content-between mb-2">
            <label>CGST (%)</label>
            <input type="number" id="cgst" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0" value="0">
          </div>
          <div class="d-flex justify-content-between mb-2">
            <label>SGST (%)</label>
            <input type="number" id="sgst" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0" value="0">
          </div>
          <div class="d-flex justify-content-between mb-2">
            <label>IGST (%)</label>
            <input type="number" id="igst" class="form-control form-control-sm text-end w-50 shadow-sm" placeholder="0" value="0">
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <label class="fw-bold text-primary">Total</label>
            <input type="text" id="total" class="form-control form-control-sm fw-bold text-end w-50 bg-light border-0" value="{{ purchase_order.total_amount }}" readonly>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="text-end mt-4">
      <button type="submit" class="btn btn-primary px-5 fw-semibold shadow-sm">
        <i class="bi bi-save me-1"></i> Update Order
      </button>
    </div>

  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addItemBtn = document.getElementById('addItemBtn');
    const itemsTableBody = document.getElementById('itemsTableBody');

    const subtotalInput = document.getElementById('subtotal');
    const ledgerInput = document.getElementById('ledger_amount');
    const cgstInput = document.getElementById('cgst');
    const sgstInput = document.getElementById('sgst');
    const igstInput = document.getElementById('igst');
    const totalInput = document.getElementById('total');

    // ✅ Function: Calculate subtotal
    function updateSubtotal() {
        let subtotal = 0;
        const amountInputs = itemsTableBody.querySelectorAll('input[name="amount[]"]');
        amountInputs.forEach(input => {
            subtotal += parseFloat(input.value) || 0;
        });
        subtotalInput.value = subtotal.toFixed(2);
        updateTotal();
    }

    // ✅ Function: Calculate total with taxes
    function updateTotal() {
        const subtotal = parseFloat(subtotalInput.value) || 0;
        const ledger = parseFloat(ledgerInput.value) || 0;
        const cgst = parseFloat(cgstInput.value) || 0;
        const sgst = parseFloat(sgstInput.value) || 0;
        const igst = parseFloat(igstInput.value) || 0;

        const cgstAmt = subtotal * (cgst / 100);
        const sgstAmt = subtotal * (sgst / 100);
        const igstAmt = subtotal * (igst / 100);

        const total = subtotal + ledger + cgstAmt + sgstAmt + igstAmt;
        totalInput.value = total.toFixed(2);
    }

    // ✅ Function: Attach qty/price listeners to a row
    function attachCalculationListeners(row) {
        const qtyInput = row.querySelector('input[name="quantity[]"]');
        const priceInput = row.querySelector('input[name="price[]"]');
        const amountInput = row.querySelector('input[name="amount[]"]');
        const discountInput = row.querySelector('input[name="discount[]"]');

        function updateAmount() {
            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            

            const discountedPrice = price - (price * (discount / 100));
            amountInput.value = (qty * discountedPrice).toFixed(2);
            updateSubtotal();
        }

        qtyInput.addEventListener('input', updateAmount);
        priceInput.addEventListener('input', updateAmount);
        discountInput.addEventListener('input', updateAmount);
    }

    // ✅ Function: Remove a row
    function removeRow(row) {
        row.remove();
        const rows = itemsTableBody.querySelectorAll('tr');
        rows.forEach((r, i) => r.cells[0].textContent = i + 1);

        if (rows.length === 1) {
            rows[0].querySelector('.remove-row').disabled = true;
        }

        updateSubtotal();
    }

    // ✅ Function: Add new row
    addItemBtn.addEventListener('click', function() {
        const rowCount = itemsTableBody.querySelectorAll('tr').length;

        const newRow = document.createElement('tr');
        newRow.className = 'item-row text-center';
        newRow.innerHTML = `
            <td>${rowCount + 1}</td>
            <td>
                <select class="form-select form-select-sm shadow-sm" name="item_description[]" onchange="fetchGarmentDetails(this)">
                    <option value="" selected disabled>Select</option>
                    {% for i in garment %}
                        <option value="{{ i.id }}">{{ i.garment_name }}</option>
                    {% endfor %}
                </select>
                <textarea class="form-control form-control-sm shadow-sm" name="description[]" rows="1" placeholder="Enter item details..."></textarea>
            </td>
            <td>
                <select class="form-select form-select-sm shadow-sm" name="color[]">
                    <option value="" selected disabled>Color</option>
                    <option value="Navy Blue">Navy Blue</option>
                    <option value="White">White</option>
                    <option value="Black">Black</option>
                    <option value="Red">Red</option>
                </select>
            </td>
            <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="quantity[]" placeholder="Qty" min="1"></td>
            <td>
                <select class="form-select form-select-sm shadow-sm text-center" name="unit[]">
                    <option value="" selected disabled>Unit</option>
                    <option>Pcs</option>
                    <option>Kg</option>
                    <option>Meter</option>
                    <option>Liter</option>
                </select>
            </td>
            <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="price[]" placeholder="0" min="0" step="0.01"></td>
            <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="discount[]" placeholder="0" step="0.01"></td>
            <td><input type="number" class="form-control form-control-sm shadow-sm text-center" name="amount[]" placeholder="0" readonly></td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger remove-row">
                    <i class="bx bx-trash"></i>
                </button>
            </td>
        `;

        itemsTableBody.appendChild(newRow);

        // Enable/disable remove buttons
        const removeButtons = itemsTableBody.querySelectorAll('.remove-row');
        removeButtons.forEach(btn => btn.disabled = removeButtons.length <= 1);

        attachCalculationListeners(newRow);

        const removeBtn = newRow.querySelector('.remove-row');
        removeBtn.addEventListener('click', function() {
            removeRow(newRow);
        });
    });

    // ✅ Garment details fetch (with recalculation)
    window.fetchGarmentDetails = function(selectElement) {
        const garmentId = selectElement.value;
        if (!garmentId) return;

        fetch(`/get-garment-details/${garmentId}/`)
            .then(res => res.json())
            .then(data => {
                const row = selectElement.closest('tr');
                row.querySelector('textarea[name="description[]"]').value = data.description || '';
                const priceInput = row.querySelector('input[name="price[]"]');
                priceInput.value = data.price || 0;

                const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
                row.querySelector('input[name="amount[]"]').value = (qty * (data.price || 0)).toFixed(2);
                updateSubtotal();
            })
            .catch(err => console.error('Error fetching details:', err));
    };

    // ✅ Initial setup for existing rows
    const existingRows = itemsTableBody.querySelectorAll('tr');
    existingRows.forEach(row => {
        attachCalculationListeners(row);
        const removeBtn = row.querySelector('.remove-row');
        removeBtn.addEventListener('click', function() {
            removeRow(row);
        });
    });

    // ✅ Update total when taxes or ledger change
    [ledgerInput, cgstInput, sgstInput, igstInput].forEach(el => {
        el.addEventListener('input', updateTotal);
    });
});
</script>

<style>
  body { background-color: #f5f7fa !important; }
  .table th, .table td { vertical-align: middle !important; }
  .form-control-sm, .form-select-sm { border-radius: 8px; }
</style>
{% endblock main-content %}
